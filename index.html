<!DOCTYPE html>
<html lang="es" class="h-full">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Verbos Irregulares ‚Äî Flashcards + Juegos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind on CDN: activar dark mode por clase y peque√±os ajustes de tema
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ["Inter", "ui-sans-serif", "system-ui", "-apple-system", "Segoe UI", "Roboto", "Ubuntu", "Cantarell", "Noto Sans", "Helvetica Neue", "Arial", "\"Apple Color Emoji\"", "\"Segoe UI Emoji\""],
          },
          boxShadow: {
            soft: '0 2px 30px rgba(0,0,0,0.08)'
          },
          colors: {
            brand: {
              50: '#eef2ff',
              100: '#e0e7ff',
              200: '#c7d2fe',
              300: '#a5b4fc',
              400: '#818cf8',
              500: '#6366f1',
              600: '#4f46e5',
              700: '#4338ca',
              800: '#3730a3',
              900: '#312e81'
            }
          },
          keyframes: {
            fadeInUp: {
              '0%': { opacity: 0, transform: 'translateY(10px)' },
              '100%': { opacity: 1, transform: 'translateY(0)' }
            },
            cardFlip: {
              '0%': { transform: 'rotateY(0deg)' },
              '100%': { transform: 'rotateY(180deg)' }
            },
            pop: {
              '0%': { transform: 'scale(0.95)', opacity: 0 },
              '100%': { transform: 'scale(1)', opacity: 1 }
            }
          },
          animation: {
            fadeInUp: 'fadeInUp 300ms ease-out',
            pop: 'pop 200ms ease-out'
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* 3D flip card */
    .flip-container { perspective: 1200px; }
    .flip-inner { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform .6s; }
    .flipped .flip-inner { transform: rotateY(180deg); }
    .flip-face { position: absolute; inset: 0; backface-visibility: hidden; -webkit-backface-visibility: hidden; }
    .flip-back { transform: rotateY(180deg); }

    /* Hide number input arrows iOS/Chrome for clean quiz fields */
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

    /* Nice scrollbar */
    .nice-scrollbar::-webkit-scrollbar { width: 10px; height: 10px; }
    .nice-scrollbar::-webkit-scrollbar-thumb { background: rgba(100,116,139,.35); border-radius: 9999px; }
    .nice-scrollbar::-webkit-scrollbar-track { background: transparent; }
  </style>
</head>

<body class="h-full bg-gradient-to-b from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-950 text-slate-800 dark:text-slate-100">
  <div id="app" class="min-h-screen flex flex-col">
    <!-- Topbar -->
    <header class="sticky top-0 z-40 backdrop-blur supports-[backdrop-filter]:bg-white/60 bg-white/80 dark:bg-slate-900/70 border-b border-slate-200/70 dark:border-slate-800">
      <!-- Desktop Header -->
      <div class="hidden sm:block max-w-6xl mx-auto px-4 py-3">
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-3 flex-1">
            <div class="h-9 w-9 grid place-items-center rounded-xl bg-gradient-to-br from-brand-500 to-indigo-600 text-white shadow-soft flex-shrink-0">
              <!-- book icon -->
              <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M20 22H6.5A2.5 2.5 0 0 1 4 19.5V4.5A2.5 2.5 0 0 1 6.5 2H20v20z"/></svg>
            </div>
            <div class="min-w-0 flex-1">
              <h1 class="text-xl font-extrabold leading-tight">Verbos Irregulares ‚Äî Flashcards & Juegos</h1>
              <p class="text-sm text-slate-500 dark:text-slate-400">UI moderna, modo estudio (SRS), juegos y estad√≠sticas. Offline-ready (LocalStorage).</p>
            </div>
          </div>
          
          <div class="flex items-center gap-2 flex-shrink-0">
            <label class="relative">
              <input id="search-input" type="text" placeholder="Buscar verbo o traducci√≥n..." class="w-64 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-3 py-2 pl-9 outline-none focus:ring-2 ring-brand-500/50" />
              <svg class="absolute left-2.5 top-2.5 h-4 w-4 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            </label>
            
            <button id="theme-toggle" class="rounded-xl p-2 hover:bg-slate-100 dark:hover:bg-slate-800" aria-label="Cambiar tema">
              <span id="icon-sun" class="hidden dark:inline-block">üåô</span>
              <span id="icon-moon" class="inline-block dark:hidden">‚òÄÔ∏è</span>
            </button>
            
            <button id="reset-progress" class="rounded-xl px-3 py-2 text-sm font-semibold bg-rose-50 text-rose-700 border border-rose-100 hover:bg-rose-100 dark:bg-rose-400/10 dark:text-rose-300 dark:border-rose-400/20">
              Reiniciar progreso
            </button>
          </div>
        </div>
      </div>

      <!-- Mobile Header -->
      <div class="sm:hidden">
        <!-- Top bar m√≥vil -->
        <div class="px-4 py-3 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="h-10 w-10 grid place-items-center rounded-2xl bg-gradient-to-br from-brand-500 to-indigo-600 text-white shadow-lg">
              <svg viewBox="0 0 24 24" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M20 22H6.5A2.5 2.5 0 0 1 4 19.5V4.5A2.5 2.5 0 0 1 6.5 2H20v20z"/></svg>
            </div>
            <div>
              <h1 class="text-lg font-bold leading-tight">Verbos Irregulares</h1>
              <p class="text-xs text-slate-500 dark:text-slate-400">Flashcards & Juegos</p>
            </div>
          </div>
          
          <div class="flex items-center gap-2">
            <button id="mobile-search-toggle" class="rounded-xl p-2.5 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700" aria-label="Buscar">
              <svg class="h-5 w-5 text-slate-600 dark:text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            </button>
            
            <button id="theme-toggle-mobile" class="rounded-xl p-2.5 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700" aria-label="Cambiar tema">
              <span id="icon-sun-mobile" class="hidden dark:inline-block text-lg">üåô</span>
              <span id="icon-moon-mobile" class="inline-block dark:hidden text-lg">‚òÄÔ∏è</span>
            </button>
            
            <button id="mobile-menu-toggle" class="rounded-xl p-2.5 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700" aria-label="Men√∫">
              <svg class="h-5 w-5 text-slate-600 dark:text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            </button>
          </div>
        </div>

        <!-- Barra de b√∫squeda m√≥vil -->
        <div id="mobile-search" class="px-4 pb-3 hidden">
          <div class="relative">
            <input id="mobile-search-input" type="text" placeholder="Buscar verbo o traducci√≥n..." class="w-full rounded-2xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-4 py-3 pl-12 outline-none focus:ring-2 ring-brand-500/50 text-base" />
            <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
          </div>
        </div>

        <!-- Men√∫ m√≥vil -->
        <div id="mobile-menu" class="px-4 pb-3 hidden">
          <div class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 overflow-hidden shadow-lg">
            <div class="p-4 border-b border-slate-200 dark:border-slate-700">
              <button id="reset-progress-mobile" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-rose-50 text-rose-700 border border-rose-100 hover:bg-rose-100 dark:bg-rose-400/10 dark:text-rose-300 dark:border-rose-400/20 font-semibold">
                <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
                Reiniciar progreso
              </button>
            </div>
            
            <div class="p-2">
              <div class="text-xs font-semibold text-slate-500 dark:text-slate-400 px-3 py-2 uppercase tracking-wider">Estad√≠sticas r√°pidas</div>
              <div class="grid grid-cols-2 gap-2 px-2 pb-2">
                <div class="bg-slate-50 dark:bg-slate-700 rounded-xl p-3 text-center">
                  <div class="text-lg font-bold text-brand-600" id="mobile-due-count">0</div>
                  <div class="text-xs text-slate-500">Debes hoy</div>
                </div>
                <div class="bg-slate-50 dark:bg-slate-700 rounded-xl p-3 text-center">
                  <div class="text-lg font-bold text-emerald-600" id="mobile-streak">0</div>
                  <div class="text-xs text-slate-500">Racha üî•</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Desktop Tabs -->
      <nav class="hidden sm:block max-w-6xl mx-auto px-4 pb-2">
        <div class="inline-flex gap-1 rounded-xl bg-slate-100/80 dark:bg-slate-800 p-1">
          <button data-tab="flashcards" class="tab-btn px-3 md:px-4 py-2 rounded-lg text-sm font-semibold bg-white dark:bg-slate-900 shadow">Flashcards</button>
          <button data-tab="typing" class="tab-btn px-3 md:px-4 py-2 rounded-lg text-sm font-semibold">Escribir</button>
          <button data-tab="choice" class="tab-btn px-3 md:px-4 py-2 rounded-lg text-sm font-semibold">Opci√≥n m√∫ltiple</button>
          <button data-tab="problem" class="tab-btn px-3 py-2 rounded-lg text-sm font-semibold relative">
            üìö Problem√°ticos
            <span id="problem-count-badge" class="absolute -top-1 -right-1 bg-rose-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
          </button>
          <button data-tab="stats" class="tab-btn px-3 md:px-4 py-2 rounded-lg text-sm font-semibold">Estad√≠sticas</button>
          <button data-tab="config" class="tab-btn px-3 md:px-4 py-2 rounded-lg text-sm font-semibold">Config</button>
        </div>
      </nav>

      <!-- Mobile Navigation -->
      <nav class="sm:hidden">
        <div class="px-4 pb-2">
          <!-- Mobile Tab Selector -->
          <div class="relative">
            <button id="mobile-tab-selector" class="w-full flex items-center justify-between px-4 py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-sm">
              <div class="flex items-center gap-3">
                <span id="mobile-tab-icon" class="text-lg">üìö</span>
                <span id="mobile-tab-text" class="font-semibold">Flashcards</span>
              </div>
              <svg class="h-5 w-5 text-slate-400 transition-transform" id="mobile-tab-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6,9 12,15 18,9"></polyline>
              </svg>
            </button>
            
            <!-- Mobile Tab Dropdown -->
            <div id="mobile-tab-dropdown" class="absolute top-full left-0 right-0 mt-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-lg z-50 hidden">
              <div class="py-2">
                <button data-tab="flashcards" class="mobile-tab-option w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                  <span class="text-lg">üìö</span>
                  <span class="font-semibold">Flashcards</span>
                </button>
                <button data-tab="typing" class="mobile-tab-option w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                  <span class="text-lg">‚úèÔ∏è</span>
                  <span class="font-semibold">Escribir</span>
                </button>
                <button data-tab="choice" class="mobile-tab-option w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                  <span class="text-lg">üéØ</span>
                  <span class="font-semibold">Opci√≥n m√∫ltiple</span>
                </button>
                <button data-tab="problem" class="mobile-tab-option w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors relative">
                  <span class="text-lg">üìö</span>
                  <span class="font-semibold">Problem√°ticos</span>
                  <span id="mobile-problem-count-badge" class="absolute right-4 bg-rose-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                </button>
                <button data-tab="stats" class="mobile-tab-option w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                  <span class="text-lg">üìä</span>
                  <span class="font-semibold">Estad√≠sticas</span>
                </button>
                <button data-tab="config" class="mobile-tab-option w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                  <span class="text-lg">‚öôÔ∏è</span>
                  <span class="font-semibold">Config</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <!-- Content -->
    <main class="flex-1">
      <div class="max-w-6xl mx-auto px-4 py-6 space-y-8">
        <!-- Row: info bar -->
        <section class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="rounded-2xl bg-white/80 dark:bg-slate-900/60 shadow-soft p-4">
            <p class="text-xs text-slate-500">Debes hoy</p>
            <p class="text-2xl font-extrabold" id="due-count">0</p>
          </div>
          <div class="rounded-2xl bg-white/80 dark:bg-slate-900/60 shadow-soft p-4">
            <p class="text-xs text-slate-500">Revisados (hoy)</p>
            <p class="text-2xl font-extrabold" id="reviewed-today">0</p>
          </div>
          <div class="rounded-2xl bg-white/80 dark:bg-slate-900/60 shadow-soft p-4">
            <p class="text-xs text-slate-500">Precisi√≥n (hoy)</p>
            <p class="text-2xl font-extrabold" id="accuracy-today">0%</p>
          </div>
          <div class="rounded-2xl bg-white/80 dark:bg-slate-900/60 shadow-soft p-4">
            <p class="text-xs text-slate-500">Racha</p>
            <p class="text-2xl font-extrabold" id="streak">0 üî•</p>
          </div>
        </section>

        <!-- Flashcards Tab -->
        <section id="tab-flashcards" class="tab-panel">
          <div class="flex flex-col md:flex-row gap-6">
            <!-- Card -->
            <div class="md:flex-1 flip-container">
              <div id="flashcard" class="flip-wrapper rounded-2xl bg-white dark:bg-slate-900 shadow-soft p-4 aspect-[3/2] cursor-pointer select-none">
                <div class="flip-inner">
                  <div class="flip-face grid place-items-center">
                    <div class="text-center space-y-4 animate-fadeInUp">
                      <p class="uppercase tracking-wider text-xs text-slate-500">Infinitivo</p>
                      <div class="flex items-center justify-center gap-2">
                        <span id="fc-inf" class="text-4xl md:text-5xl font-extrabold"></span>
                        <button id="fc-speak-inf" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800" aria-label="Escuchar infinitivo">üîà</button>
                      </div>
                      <p id="fc-trans" class="text-slate-500 dark:text-slate-400"></p>
                      <p class="text-xs text-slate-500">Pulsa o presiona <kbd class="px-1.5 py-0.5 rounded bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700">espacio</kbd> para voltear</p>
                    </div>
                  </div>
                  <div class="flip-face flip-back grid place-items-center">
                    <div class="text-center space-y-3 animate-fadeInUp">
                      <div>
                        <p class="uppercase tracking-wider text-xs text-slate-500">Infinitivo</p>
                        <div class="flex items-center justify-center gap-2">
                          <span id="fc-back-inf" class="text-xl font-semibold"></span>
                          <button id="fc-speak-inf-back" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800" aria-label="Escuchar infinitivo">üîà</button>
                        </div>
                      </div>
                      <div>
                        <p class="uppercase tracking-wider text-xs text-slate-500">Pasado simple</p>
                        <div class="flex items-center justify-center gap-2">
                          <span id="fc-past" class="text-2xl font-bold text-brand-600"></span>
                          <button id="fc-speak-past" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800" aria-label="Escuchar pasado">üîà</button>
                        </div>
                      </div>
                      <div>
                        <p class="uppercase tracking-wider text-xs text-slate-500">Participio</p>
                        <div class="flex items-center justify-center gap-2">
                          <span id="fc-part" class="text-2xl font-bold text-brand-600"></span>
                          <button id="fc-speak-part" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800" aria-label="Escuchar participio">üîà</button>
                        </div>
                      </div>
                      <div>
                        <p class="uppercase tracking-wider text-xs text-slate-500">Ejemplos</p>
                        <div class="max-w-md mx-auto text-sm text-slate-600 dark:text-slate-300 space-y-1">
                          <p id="fc-ex1"></p>
                          <p id="fc-ex2"></p>
                          <p id="fc-ex3"></p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="mt-4 grid grid-cols-2 sm:grid-cols-5 gap-2">
                <button id="prev-btn" class="col-span-1 rounded-xl bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 px-3 py-2">‚Üê Anterior</button>
                <button id="random-btn" class="col-span-1 rounded-xl bg-indigo-50 text-brand-700 border border-brand-200 hover:bg-indigo-100 px-3 py-2">üé≤ Aleatoria</button>
                <button id="next-btn" class="col-span-1 rounded-xl bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 px-3 py-2">Siguiente ‚Üí</button>
                <div class="col-span-2 flex items-center justify-end gap-2">
                  <span id="counter-display" class="text-sm text-slate-500"></span>
                </div>
              </div>

              <div class="mt-3 grid grid-cols-3 gap-2">
                <button data-grade="hard" class="grade-btn rounded-xl px-3 py-2 bg-rose-50 text-rose-700 border border-rose-100 hover:bg-rose-100">Dif√≠cil</button>
                <button data-grade="good" class="grade-btn rounded-xl px-3 py-2 bg-amber-50 text-amber-700 border border-amber-100 hover:bg-amber-100">Bien</button>
                <button data-grade="easy" class="grade-btn rounded-xl px-3 py-2 bg-emerald-50 text-emerald-700 border border-emerald-100 hover:bg-emerald-100">F√°cil</button>
              </div>
              
              <div class="mt-3 flex items-center justify-center">
                <button id="toggle-problem-verb" class="flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold border transition-all">
                  <span id="problem-icon">üìå</span>
                  <span id="problem-text">Marcar como problem√°tico</span>
                </button>
              </div>
            </div>

            <!-- Sidebar: ajustes r√°pidos + lista -->
            <aside class="md:w-[340px] space-y-4">
              <div class="rounded-2xl bg-white dark:bg-slate-900 shadow-soft p-4 space-y-3">
                <label class="flex items-center justify-between gap-3">
                  <span class="text-sm">Practicar solo pendientes (SRS)</span>
                  <input id="toggle-due-only" type="checkbox" class="w-5 h-5 accent-brand-600" />
                </label>
                <label class="flex items-center justify-between gap-3">
                  <span class="text-sm">Auto audio al voltear</span>
                  <input id="toggle-auto-tts" type="checkbox" class="w-5 h-5 accent-brand-600" />
                </label>
                <label class="flex items-center justify-between gap-3">
                  <span class="text-sm">Velocidad TTS</span>
                  <input id="range-tts" type="range" min="0.6" max="1.2" value="0.9" step="0.05" class="w-full" />
                </label>
                <div>
                  <p class="text-xs text-slate-500 font-medium mb-2">Atajos de teclado:</p>
                  <div id="flashcard-shortcuts" class="grid grid-cols-1 gap-1 text-xs text-slate-600 dark:text-slate-400">
                    <!-- Los atajos se llenar√°n din√°micamente seg√∫n el SO -->
                  </div>
                </div>
              </div>

              <div class="rounded-2xl bg-white dark:bg-slate-900 shadow-soft p-4 max-h-[380px] overflow-auto nice-scrollbar">
                <h3 class="font-semibold mb-2">Diccionario r√°pido</h3>
                <ul id="quick-list" class="space-y-1 text-sm"></ul>
              </div>
            </aside>
          </div>
        </section>

        <!-- Typing Tab (Escribir) -->
        <section id="tab-typing" class="tab-panel hidden">
          <div class="rounded-2xl bg-white dark:bg-slate-900 shadow-soft p-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
              <h2 class="text-xl font-bold">Juego: Completa las formas</h2>
              <div class="flex items-center gap-2 text-sm">
                <button id="typing-reset" class="rounded-lg px-3 py-1.5 bg-slate-100 dark:bg-slate-800">Reiniciar</button>
                <button id="typing-next" class="rounded-lg px-3 py-1.5 bg-brand-600 text-white">Siguiente verbo</button>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <p class="text-slate-600 dark:text-slate-300">Infinitivo: <strong id="t-inf" class="text-brand-600"></strong> ‚Äî <strong id="t-trans" class="text-brand-600"></strong></p>
              <button id="t-speak-inf" class="p-1.5 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800" aria-label="Escuchar infinitivo">üîà</button>
            </div>

            <div class="mt-4 grid md:grid-cols-2 gap-4">
              <div>
                <label class="text-sm text-slate-500">Pasado simple</label>
                <div class="relative">
                  <input id="t-input-past" type="text" class="mt-1 w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 pr-10 outline-none focus:ring-2 ring-brand-500/50" placeholder="Escribe el Pasado Simple..." />
                  <button id="t-speak-past" class="absolute right-2 top-1/2 transform -translate-y-1/2 mt-0.5 p-1.5 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 opacity-0 transition-opacity" aria-label="Escuchar pasado" style="display: none;">üîà</button>
                </div>
                <div id="t-fb-past" class="h-5 text-sm mt-1"></div>
              </div>
              <div>
                <label class="text-sm text-slate-500">Participio</label>
                <div class="relative">
                  <input id="t-input-part" type="text" class="mt-1 w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 pr-10 outline-none focus:ring-2 ring-brand-500/50" placeholder="Escribe el Participio..." />
                  <button id="t-speak-part" class="absolute right-2 top-1/2 transform -translate-y-1/2 mt-0.5 p-1.5 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 opacity-0 transition-opacity" aria-label="Escuchar participio" style="display: none;">üîà</button>
                </div>
                <div id="t-fb-part" class="h-5 text-sm mt-1"></div>
              </div>
            </div>

            <div class="mt-4 flex flex-wrap items-center gap-2">
              <button id="t-check" class="rounded-xl bg-emerald-600 text-white px-4 py-2">Comprobar</button>
              <button id="t-show" class="rounded-xl bg-amber-500 text-white px-4 py-2">Mostrar respuestas</button>
              <span class="ml-auto">Puntuaci√≥n: <strong id="t-score">0</strong></span>
            </div>
            
            <div class="mt-3 p-3 rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
              <p class="text-xs text-slate-500 font-medium mb-2">Atajos de teclado:</p>
              <div id="typing-shortcuts" class="grid grid-cols-1 sm:grid-cols-3 gap-2 text-xs text-slate-600 dark:text-slate-400">
                <!-- Los atajos se llenar√°n din√°micamente seg√∫n el SO -->
              </div>
            </div>
          </div>
        </section>

        <!-- Problem Verbs Tab -->
        <section id="tab-problem" class="tab-panel hidden">
          <div class="space-y-4 sm:space-y-6">
            <div class="rounded-2xl bg-white dark:bg-slate-900 shadow-soft p-4 sm:p-6">
              <!-- Header responsive -->
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                <h2 class="text-lg sm:text-xl font-bold flex items-center gap-2">
                  üìö Verbos Problem√°ticos
                  <span id="total-problem-verbs" class="text-base sm:text-lg text-slate-500">(0)</span>
                </h2>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                  <button id="study-problem-verbs" class="rounded-xl bg-brand-600 text-white px-3 sm:px-4 py-2 text-sm sm:text-base font-semibold disabled:opacity-50 order-2 sm:order-1">
                    <span class="hidden sm:inline">Estudiar problem√°ticos</span>
                    <span class="sm:hidden">Estudiar</span>
                  </button>
                  <button id="clear-all-problems" class="rounded-xl bg-slate-100 dark:bg-slate-800 px-3 sm:px-4 py-2 text-sm sm:text-base font-semibold order-1 sm:order-2">
                    <span class="hidden sm:inline">Limpiar todo</span>
                    <span class="sm:hidden">Limpiar</span>
                  </button>
                </div>
              </div>
              
              <!-- Cards de estad√≠sticas -->
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 mb-4">
                <div class="p-3 sm:p-4 rounded-xl bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-800">
                  <div class="flex items-center justify-between">
                    <div class="flex-1">
                      <h3 class="font-semibold text-rose-800 dark:text-rose-200 mb-1 sm:mb-2 text-sm sm:text-base">üö® Auto-marcados</h3>
                      <p class="text-xs sm:text-sm text-rose-600 dark:text-rose-300 hidden sm:block">Verbos en los que has fallado al escribir</p>
                    </div>
                    <div class="text-xl sm:text-2xl font-bold text-rose-700 dark:text-rose-300" id="auto-marked-count">0</div>
                  </div>
                </div>
                <div class="p-3 sm:p-4 rounded-xl bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800">
                  <div class="flex items-center justify-between">
                    <div class="flex-1">
                      <h3 class="font-semibold text-amber-800 dark:text-amber-200 mb-1 sm:mb-2 text-sm sm:text-base">üìå Manuales</h3>
                      <p class="text-xs sm:text-sm text-amber-600 dark:text-amber-300 hidden sm:block">Verbos que consideras dif√≠ciles</p>
                    </div>
                    <div class="text-xl sm:text-2xl font-bold text-amber-700 dark:text-amber-300" id="manual-marked-count">0</div>
                  </div>
                </div>
              </div>
              
              <!-- Filtros y lista -->
              <div class="space-y-3">
                <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                  <h3 class="font-semibold text-sm sm:text-base">Lista de verbos problem√°ticos:</h3>
                  <div class="flex items-center gap-2 text-xs sm:text-sm">
                    <label class="flex items-center gap-1">
                      <input type="radio" name="problem-filter" value="all" checked class="w-3 h-3 sm:w-4 sm:h-4 accent-brand-600">
                      <span class="hidden sm:inline">Todos</span>
                      <span class="sm:hidden">Todo</span>
                    </label>
                    <label class="flex items-center gap-1">
                      <input type="radio" name="problem-filter" value="auto" class="w-3 h-3 sm:w-4 sm:h-4 accent-brand-600">
                      <span class="hidden sm:inline">Auto-marcados</span>
                      <span class="sm:hidden">Auto</span>
                    </label>
                    <label class="flex items-center gap-1">
                      <input type="radio" name="problem-filter" value="manual" class="w-3 h-3 sm:w-4 sm:h-4 accent-brand-600">
                      <span class="hidden sm:inline">Manuales</span>
                      <span class="sm:hidden">Manual</span>
                    </label>
                  </div>
                </div>
                <div id="problem-verbs-list" class="max-h-64 sm:max-h-96 overflow-auto nice-scrollbar border border-slate-200 dark:border-slate-700 rounded-xl">
                  <!-- Lista se llenar√° din√°micamente -->
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Multiple Choice Tab -->
        <section id="tab-choice" class="tab-panel hidden">
          <div class="rounded-2xl bg-white dark:bg-slate-900 shadow-soft p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-bold">Opci√≥n m√∫ltiple</h2>
              <div class="text-sm text-slate-500">Puntuaci√≥n: <strong id="mc-score">0</strong></div>
            </div>
            
            <div class="mb-4 p-3 rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
              <p class="text-xs text-slate-500 font-medium mb-2">Atajos de teclado:</p>
              <div id="mc-shortcuts" class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs text-slate-600 dark:text-slate-400">
                <!-- Los atajos se llenar√°n din√°micamente -->
              </div>
            </div>
            <div id="mc-card" class="space-y-4">
              <p class="text-slate-600 dark:text-slate-300">Infinitivo: <strong id="mc-inf" class="text-brand-600"></strong> ‚Äî <strong id="mc-trans" class="text-brand-600"></strong></p>
              <div>
                <p class="text-sm text-slate-500 mb-1">Elige el <strong>Pasado simple</strong> correcto:</p>
                <div id="mc-opts-past" class="grid sm:grid-cols-2 gap-2"></div>
              </div>
              <div>
                <p class="text-sm text-slate-500 mb-1">Elige el <strong>Participio</strong> correcto:</p>
                <div id="mc-opts-part" class="grid sm:grid-cols-2 gap-2"></div>
              </div>
              <div class="flex items-center gap-2">
                <button id="mc-next" class="rounded-xl bg-brand-600 text-white px-4 py-2">Siguiente</button>
                <button id="mc-speak" class="rounded-xl px-3 py-2 bg-slate-100 dark:bg-slate-800">üîà Escuchar</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Stats Tab -->
        <section id="tab-stats" class="tab-panel hidden">
          <div class="grid lg:grid-cols-2 gap-6">
            <div class="rounded-2xl bg-white dark:bg-slate-900 shadow-soft p-6">
              <h3 class="font-bold mb-4">Rendimiento diario (√∫ltimos 7 d√≠as)</h3>
              <div id="daily-bars" class="grid grid-cols-7 gap-2 items-end h-40"></div>
              <div class="mt-2 grid grid-cols-7 text-xs text-center text-slate-500" id="daily-labels"></div>
            </div>
            <div class="rounded-2xl bg-white dark:bg-slate-900 shadow-soft p-6">
              <h3 class="font-bold mb-2">Distribuci√≥n SRS</h3>
              <div id="srs-dist" class="grid grid-cols-5 gap-3 mt-4">
                <!-- Boxes placeholder -->
              </div>
            </div>
          </div>
        </section>

        <!-- Config Tab -->
        <section id="tab-config" class="tab-panel hidden">
          <div class="rounded-2xl bg-white dark:bg-slate-900 shadow-soft p-6 space-y-6">
            <div>
              <h3 class="font-bold mb-2">Gesti√≥n de datos</h3>
              <div class="flex flex-wrap items-center gap-2">
                <button id="export-json" class="rounded-xl bg-slate-100 dark:bg-slate-800 px-3 py-2">Exportar JSON</button>
                <label class="rounded-xl bg-slate-100 dark:bg-slate-800 px-3 py-2 cursor-pointer">
                  Importar JSON
                  <input id="import-json" type="file" accept="application/json" class="hidden" />
                </label>
              </div>
              <p class="text-xs text-slate-500 mt-1">Puedes exportar tu progreso y tus verbos personalizados y volver a importarlos.</p>
            </div>

            <div class="grid md:grid-cols-2 gap-4">
              <div class="space-y-2">
                <h4 class="font-semibold">A√±adir verbo personalizado</h4>
                <div class="grid grid-cols-2 gap-2">
                  <input id="add-inf" type="text" placeholder="Infinitivo" class="rounded-xl px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700" />
                  <input id="add-trans" type="text" placeholder="Traducci√≥n" class="rounded-xl px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700" />
                  <input id="add-past" type="text" placeholder="Pasado simple (ej. learnt/learned)" class="col-span-2 rounded-xl px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700" />
                  <input id="add-part" type="text" placeholder="Participio (ej. learnt/learned)" class="col-span-2 rounded-xl px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700" />
                </div>
                <button id="add-verb" class="mt-2 rounded-xl bg-emerald-600 text-white px-4 py-2">Agregar</button>
                <p class="text-xs text-slate-500">Se aceptan m√∫ltiples variantes separadas por "/" y valores entre par√©ntesis. El TTS limpia pronunciaciones como <code>/r…õd/</code>.</p>
              </div>

              <div class="space-y-2">
                <h4 class="font-semibold">Preferencias</h4>
                <label class="flex items-center justify-between gap-3">
                  <span class="text-sm">Modo oscuro por defecto</span>
                  <input id="pref-dark-default" type="checkbox" class="w-5 h-5 accent-brand-600" />
                </label>
                <label class="flex items-center justify-between gap-3">
                  <span class="text-sm">Solo estudiar pendientes (SRS) por defecto</span>
                  <input id="pref-due-default" type="checkbox" class="w-5 h-5 accent-brand-600" />
                </label>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <footer class="border-t border-slate-200 dark:border-slate-800 text-xs text-slate-500 py-4">
      <div class="max-w-6xl mx-auto px-4 flex items-center justify-between">
        <p>Hecho con ‚ô• para aprender verbos. Datos almacenados localmente.</p>
        <p><span id="total-verbs">0</span> verbos disponibles</p>
      </div>
    </footer>
  </div>

  <!-- App Code -->
  <script>
    // ============================
    // Datos base de verbos
    // ============================
    const BASE_VERBS = [
      { infinitive: "be", pastSimple: "was/were", participle: "been", translation: "ser / estar" },
      { infinitive: "become", pastSimple: "became", participle: "become", translation: "convertirse en" },
      { infinitive: "begin", pastSimple: "began", participle: "begun", translation: "comenzar" },
      { infinitive: "break", pastSimple: "broke", participle: "broken", translation: "romper" },
      { infinitive: "bring", pastSimple: "brought", participle: "brought", translation: "traer" },
      { infinitive: "build", pastSimple: "built", participle: "built", translation: "construir" },
      { infinitive: "buy", pastSimple: "bought", participle: "bought", translation: "comprar" },
      { infinitive: "can", pastSimple: "could", participle: "(been able to)", translation: "poder" },
      { infinitive: "catch", pastSimple: "caught", participle: "caught", translation: "atrapar" },
      { infinitive: "choose", pastSimple: "chose", participle: "chosen", translation: "elegir" },
      { infinitive: "come", pastSimple: "came", participle: "come", translation: "venir" },
      { infinitive: "cost", pastSimple: "cost", participle: "cost", translation: "costar" },
      { infinitive: "cut", pastSimple: "cut", participle: "cut", translation: "cortar" },
      { infinitive: "drink", pastSimple: "drank", participle: "drunk", translation: "beber" },
      { infinitive: "eat", pastSimple: "ate", participle: "eaten", translation: "comer" },
      { infinitive: "fall", pastSimple: "fell", participle: "fallen", translation: "caer" },
      { infinitive: "feel", pastSimple: "felt", participle: "felt", translation: "sentir" },
      { infinitive: "find", pastSimple: "found", participle: "found", translation: "encontrar" },
      { infinitive: "forget", pastSimple: "forgot", participle: "forgotten", translation: "olvidar" },
      { infinitive: "get", pastSimple: "got", participle: "got", translation: "conseguir / obtener" },
      { infinitive: "give", pastSimple: "gave", participle: "given", translation: "dar" },
      { infinitive: "go", pastSimple: "went", participle: "gone/been", translation: "ir" },
      { infinitive: "grow", pastSimple: "grew", participle: "grown", translation: "crecer" },
      { infinitive: "have", pastSimple: "had", participle: "had", translation: "tener" },
      { infinitive: "hear", pastSimple: "heard", participle: "heard", translation: "o√≠r" },
      { infinitive: "hit", pastSimple: "hit", participle: "hit", translation: "golpear" },
      { infinitive: "hold", pastSimple: "held", participle: "held", translation: "sostener" },
      { infinitive: "hurt", pastSimple: "hurt", participle: "hurt", translation: "herir / doler" },
      { infinitive: "keep", pastSimple: "kept", participle: "kept", translation: "mantener / guardar" },
      { infinitive: "know", pastSimple: "knew", participle: "known", translation: "saber / conocer" },
      { infinitive: "leave", pastSimple: "left", participle: "left", translation: "dejar / salir de" },
      { infinitive: "lend", pastSimple: "lent", participle: "lent", translation: "prestar" },
      { infinitive: "let", pastSimple: "let", participle: "let", translation: "permitir" },
      { infinitive: "lose", pastSimple: "lost", participle: "lost", translation: "perder" },
      { infinitive: "make", pastSimple: "made", participle: "made", translation: "hacer / fabricar" },
      { infinitive: "mean", pastSimple: "meant", participle: "meant", translation: "significar" },
      { infinitive: "meet", pastSimple: "met", participle: "met", translation: "conocer / reunirse" },
      { infinitive: "must", pastSimple: "had to", participle: "(had to)", translation: "deber / tener que" },
      { infinitive: "pay", pastSimple: "paid", participle: "paid", translation: "pagar" },
      { infinitive: "put", pastSimple: "put", participle: "put", translation: "poner" },
      { infinitive: "read", pastSimple: "read /r…õd/", participle: "read /r…õd/", translation: "leer" },
      { infinitive: "ride", pastSimple: "rode", participle: "ridden", translation: "montar" },
      { infinitive: "run", pastSimple: "ran", participle: "run", translation: "correr" },
      { infinitive: "say", pastSimple: "said", participle: "said", translation: "decir" },
      { infinitive: "see", pastSimple: "saw", participle: "seen", translation: "ver" },
      { infinitive: "sell", pastSimple: "sold", participle: "sold", translation: "vender" },
      { infinitive: "set", pastSimple: "set", participle: "set", translation: "colocar / establecer" },
      { infinitive: "shut", pastSimple: "shut", participle: "shut", translation: "cerrar" },
      { infinitive: "sing", pastSimple: "sang", participle: "sung", translation: "cantar" },
      { infinitive: "sit", pastSimple: "sat", participle: "sat", translation: "sentarse" },
      { infinitive: "sleep", pastSimple: "slept", participle: "slept", translation: "dormir" },
      { infinitive: "speak", pastSimple: "spoke", participle: "spoken", translation: "hablar" },
      { infinitive: "spell", pastSimple: "spelt/spelled", participle: "spelt/spelled", translation: "deletrear" },
      { infinitive: "spend", pastSimple: "spent", participle: "spent", translation: "gastar / pasar (tiempo)" },
      { infinitive: "stand", pastSimple: "stood", participle: "stood", translation: "estar de pie" },
      { infinitive: "steal", pastSimple: "stole", participle: "stolen", translation: "robar" },
      { infinitive: "take", pastSimple: "took", participle: "taken", translation: "tomar / llevar" },
      { infinitive: "teach", pastSimple: "taught", participle: "taught", translation: "ense√±ar" },
      { infinitive: "tell", pastSimple: "told", participle: "told", translation: "decir / contar" },
      { infinitive: "think", pastSimple: "thought", participle: "thought", translation: "pensar" },
      { infinitive: "throw", pastSimple: "threw", participle: "thrown", translation: "lanzar / tirar" },
      { infinitive: "understand", pastSimple: "understood", participle: "understood", translation: "entender" },
      { infinitive: "wear", pastSimple: "wore", participle: "worn", translation: "llevar puesto / usar ropa" },
      { infinitive: "win", pastSimple: "won", participle: "won", translation: "ganar" },
      { infinitive: "write", pastSimple: "wrote", participle: "written", translation: "escribir" }
    ];

    // ============================
    // Utilidades
    // ============================
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

    // Detectar si es Mac para mostrar los atajos correctos
    const isMac = /Mac|iPod|iPhone|iPad/.test(navigator.platform) || navigator.platform === 'MacIntel';
    const modifierKey = isMac ? 'Cmd' : 'Ctrl';

    const todayKey = () => new Date().toISOString().slice(0, 10);
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    function shuffleInPlace(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // Limpia strings de respuestas: quita pronunciaci√≥n /r…õd/, par√©ntesis y espacios extra.
    function normalizeForm(s, { forPronunciation = false } = {}) {
      if (!s) return '';
      let x = String(s).trim();
      // Si es "read /r…õd/" aceptamos "read"; para TTS pronunciamos "red" (si forPronunciation)
      if (x.toLowerCase().includes('/r…õd/')) {
        return forPronunciation ? 'red' : 'read';
      }
      // Si est√° entre par√©ntesis, quita par√©ntesis
      if (x.startsWith('(') && x.endsWith(')')) x = x.slice(1, -1);
      // Recorta espacios alrededor de '/'
      x = x.replace(/\s*\/\s*/g, '/');
      // Quita duplicados de espacios
      x = x.replace(/\s+/g, ' ').trim();
      return x;
    }

    function parseOptions(formString) {
      if (!formString) return [];
      const cleaned = normalizeForm(formString);
      return cleaned.split('/')
        .map(s => s.trim().toLowerCase())
        .filter(Boolean);
    }

    function speak(text, lang = 'en-US') {
      if (!('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = lang;
      u.rate = settings.ttsRate || 0.9;
      const voices = window.speechSynthesis.getVoices();
      const v = voices.find(v => v.lang.startsWith('en-') && v.name.toLowerCase().includes('google'))
        || voices.find(v => v.lang.startsWith('en-') && v.default)
        || voices.find(v => v.lang.startsWith('en-'));
      if (v) u.voice = v;
      window.speechSynthesis.speak(u);
    }

    // ============================
    // Estado y almacenamiento
    // ============================
    const LS_KEYS = {
      verbs: 'irregular_verbs:data',
      srs: 'irregular_verbs:srs',
      settings: 'irregular_verbs:settings',
      history: 'irregular_verbs:history',
      streak: 'irregular_verbs:streak',
      problemVerbs: 'irregular_verbs:problem_verbs'
    };

    function loadJSON(key, fallback) {
      try { const v = JSON.parse(localStorage.getItem(key)); return v ?? fallback; } catch { return fallback; }
    }
    function saveJSON(key, value) { localStorage.setItem(key, JSON.stringify(value)); }

    let verbs = loadJSON(LS_KEYS.verbs, BASE_VERBS);
    let srs = loadJSON(LS_KEYS.srs, {}); // { [id]: { box, dueAt, stats: { seen, correct, wrong } } }
    let settings = loadJSON(LS_KEYS.settings, { darkDefault: false, dueOnlyDefault: false, autoTts: false, ttsRate: 0.9 });
    let history = loadJSON(LS_KEYS.history, {}); // { 'YYYY-MM-DD': { reviewed, correct } }
    let streak = loadJSON(LS_KEYS.streak, { lastDay: null, count: 0 });
    let problemVerbs = loadJSON(LS_KEYS.problemVerbs, {}); // { [id]: { markedAt, autoMarked, attempts, lastFailed } }

    // Normaliza y asigna IDs
    function ensureIds() {
      verbs.forEach((v, idx) => { if (!v.id) v.id = `${v.infinitive.toLowerCase()}-${idx}`; });
    }
    ensureIds();

    // ============================
    // L√≥gica SRS (Leitner simplificado)
    // ============================
    const BOX_INTERVALS = { 1: 0, 2: 1, 3: 3, 4: 7, 5: 16 }; // d√≠as

    function nowTs() { return Date.now(); }
    function daysFromNow(n) { return nowTs() + n * 24 * 60 * 60 * 1000; }

    function getCardState(v) {
      const rec = srs[v.id] || { box: 1, dueAt: 0, stats: { seen: 0, correct: 0, wrong: 0 } };
      return rec;
    }

    function schedule(v, grade) { // hard/good/easy
      const rec = getCardState(v);
      rec.stats.seen++;
      const isCorrect = grade !== 'hard';
      if (isCorrect) rec.stats.correct++; else rec.stats.wrong++;
      let box = rec.box;
      if (grade === 'hard') box = Math.max(1, box - 1);
      if (grade === 'good') box = Math.min(5, box + 1);
      if (grade === 'easy') box = Math.min(5, box + 2);
      rec.box = box;
      rec.dueAt = daysFromNow(BOX_INTERVALS[box]);
      srs[v.id] = rec;
      saveJSON(LS_KEYS.srs, srs);
      // actualizar historial
      const k = todayKey();
      history[k] = history[k] || { reviewed: 0, correct: 0 };
      history[k].reviewed++;
      if (isCorrect) history[k].correct++;
      saveJSON(LS_KEYS.history, history);
      updateStreak();
    }

    function getDue(list = verbs) {
      const now = nowTs();
      return list.filter(v => (getCardState(v).dueAt || 0) <= now);
    }

    function updateStreak() {
      const k = todayKey();
      if (history[k] && history[k].reviewed > 0) {
        if (streak.lastDay === k) return;
        if (!streak.lastDay) {
          streak.lastDay = k; streak.count = 1;
        } else {
          const prev = new Date(streak.lastDay);
          const today = new Date(k);
          const diffDays = Math.round((today - prev) / (1000 * 60 * 60 * 24));
          streak.count = diffDays === 1 ? streak.count + 1 : (diffDays === 0 ? streak.count : 1);
          streak.lastDay = k;
        }
        saveJSON(LS_KEYS.streak, streak);
      }
    }

    // ============================
    // Estado de UI
    // ============================
    const ui = {
      idx: 0,
      order: [...verbs.keys()],
      dueOnly: settings.dueOnlyDefault || false,
      autoTts: settings.autoTts || false,
      ttsRate: settings.ttsRate || 0.9,
      currentVerb() { return verbs[this.order[this.idx]]; }
    };

    function reshuffleOrder() {
      ui.order = verbs.map((_, i) => i);
      if (ui.dueOnly) {
        const indices = verbs.map((v, i) => ({ v, i })).filter(({ v }) => getDue([v]).length);
        ui.order = indices.map(x => x.i);
      }
      shuffleInPlace(ui.order);
      ui.idx = 0;
    }

    // ============================
    // Render helpers
    // ============================
    function renderTopStats() {
      $('#due-count').textContent = getDue().length;
      const k = todayKey();
      const h = history[k] || { reviewed: 0, correct: 0 };
      $('#reviewed-today').textContent = h.reviewed;
      const acc = h.reviewed ? Math.round((h.correct / h.reviewed) * 100) : 0;
      $('#accuracy-today').textContent = `${acc}%`;
      $('#streak').textContent = `${streak.count || 0} üî•`;
      $('#total-verbs').textContent = verbs.length;
      
      // Actualizar elementos m√≥viles
      $('#mobile-due-count').textContent = getDue().length;
      $('#mobile-streak').textContent = streak.count || 0;
    }

    function buildExamples(v) {
      const ps = parseOptions(v.pastSimple)[0] || v.pastSimple;
      const pp = parseOptions(v.participle)[0] || v.participle;
      return [
        `I ${v.infinitive} every day.`,
        `Yesterday I ${ps}.`,
        `I have ${pp}.`
      ];
    }

    function renderQuickList(filter = '') {
      const ul = $('#quick-list');
      ul.innerHTML = '';
      const f = filter.trim().toLowerCase();
      const arr = verbs.filter(v => !f || v.infinitive.toLowerCase().includes(f) || (v.translation || '').toLowerCase().includes(f));
      for (const v of arr) {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between gap-2 px-2 py-1 rounded hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer';
        li.innerHTML = `<span><strong>${v.infinitive}</strong> <span class="text-slate-500">‚Äî ${v.translation}</span></span><span class="text-xs text-slate-400">${getCardState(v).box ? 'B' + getCardState(v).box : ''}</span>`;
        li.addEventListener('click', () => {
          const idx = verbs.findIndex(x => x.id === v.id);
          ui.order = [idx]; ui.idx = 0; renderFlashcard();
        });
        ul.appendChild(li);
      }
    }

    // ============================
    // Flashcards
    // ============================
    function renderFlashcard() {
      const v = ui.currentVerb();
      if (!v) { $('#fc-inf').textContent = '‚Äî'; return; }
      $('#fc-inf').textContent = v.infinitive;
      $('#fc-back-inf').textContent = v.infinitive;
      $('#fc-trans').textContent = v.translation || '';
      $('#fc-past').textContent = normalizeForm(v.pastSimple);
      $('#fc-part').textContent = normalizeForm(v.participle);
      const [e1, e2, e3] = buildExamples(v);
      $('#fc-ex1').textContent = e1; $('#fc-ex2').textContent = e2; $('#fc-ex3').textContent = e3;
      $('#counter-display').textContent = `${ui.idx + 1} / ${ui.order.length}`;
      $('#flashcard').classList.remove('flipped');
      updateProblemButtonState();
      if (ui.autoTts) speak(v.infinitive);
    }

    function flipCard() { $('#flashcard').classList.toggle('flipped'); if (ui.autoTts) { const v = ui.currentVerb(); speak(parseOptions(v.pastSimple)[0] || v.pastSimple); speak(parseOptions(v.participle)[0] || v.participle); } }

    function nav(delta) {
      ui.idx = clamp(ui.idx + delta, 0, ui.order.length - 1);
      renderFlashcard();
    }

    function randomCard() {
      ui.idx = randInt(0, ui.order.length - 1);
      renderFlashcard();
    }

    function gradeCurrent(grade) {
      const v = ui.currentVerb();
      if (!v) return;
      schedule(v, grade);
      renderTopStats();
      nav(+1);
    }

    // ============================
    // Typing (Escribir)
    // ============================
    const typing = {
      order: [],
      idx: 0,
      score: 0,
      answered: false,
      current() { return verbs[this.order[this.idx]]; }
    };

    function typingStart() {
      typing.order = verbs.map((_, i) => i);
      shuffleInPlace(typing.order);
      typing.idx = 0; typing.score = 0; typing.answered = false;
      typingLoad();
    }

    function isCorrectInput(user, correctStr) {
      const u = normalizeForm(user).toLowerCase();
      const opts = parseOptions(correctStr);
      return opts.includes(u);
    }

    function typingLoad() {
      const v = typing.current(); if (!v) return;
      $('#t-inf').textContent = v.infinitive; $('#t-trans').textContent = v.translation || '';
      $('#t-input-past').value = ''; $('#t-input-part').value = '';
      $('#t-fb-past').textContent = ''; $('#t-fb-part').textContent = '';
      $('#t-score').textContent = typing.score;
      typing.answered = false;
      $('#t-input-past').disabled = false; $('#t-input-part').disabled = false;
      $('#t-check').disabled = false; $('#t-show').disabled = false;
      
      // Ocultar botones de audio al cargar nuevo verbo
      hideTypingAudioButtons();
      
      $('#t-input-past').focus();
    }

    function typingCheck() {
      if (typing.answered) return;
      const v = typing.current();
      const p = $('#t-input-past').value; const pp = $('#t-input-part').value;
      const pastOk = isCorrectInput(p, v.pastSimple);
      const partOk = isCorrectInput(pp, v.participle);
      $('#t-fb-past').textContent = pastOk ? '¬°Correcto!' : `Incorrecto ‚Üí ${parseOptions(v.pastSimple)[0] || v.pastSimple}`;
      $('#t-fb-past').className = `h-5 text-sm ${pastOk ? 'text-emerald-600 font-semibold' : 'text-rose-600 font-semibold'}`;
      $('#t-fb-part').textContent = partOk ? '¬°Correcto!' : `Incorrecto ‚Üí ${parseOptions(v.participle)[0] || v.participle}`;
      $('#t-fb-part').className = `h-5 text-sm ${partOk ? 'text-emerald-600 font-semibold' : 'text-rose-600 font-semibold'}`;
      if (pastOk && partOk) { 
        typing.score++; 
        schedule(v, 'good'); 
      } else { 
        schedule(v, 'hard'); 
        // Marcar autom√°ticamente como problem√°tico si falla
        markProblemVerb(v, true);
      }
      $('#t-score').textContent = typing.score;
      typing.answered = true;
      $('#t-check').disabled = true; $('#t-show').disabled = true;
      $('#t-input-past').disabled = true; $('#t-input-part').disabled = true;
      
      // Mostrar botones de audio despu√©s de comprobar
      showTypingAudioButtons();
      renderTopStats();
    }

    function typingShow() {
      if (typing.answered) return;
      const v = typing.current();
      $('#t-input-past').value = parseOptions(v.pastSimple)[0] || v.pastSimple;
      $('#t-input-part').value = parseOptions(v.participle)[0] || v.participle;
      typing.answered = true;
      $('#t-check').disabled = true; $('#t-show').disabled = true;
      $('#t-input-past').disabled = true; $('#t-input-part').disabled = true;
      
      // Mostrar botones de audio despu√©s de mostrar respuestas
      showTypingAudioButtons();
    }

    function showTypingAudioButtons() {
      const pastBtn = $('#t-speak-past');
      const partBtn = $('#t-speak-part');
      
      if (pastBtn) {
        pastBtn.style.display = 'block';
        pastBtn.style.opacity = '1';
      }
      if (partBtn) {
        partBtn.style.display = 'block';
        partBtn.style.opacity = '1';
      }
    }

    function hideTypingAudioButtons() {
      const pastBtn = $('#t-speak-past');
      const partBtn = $('#t-speak-part');
      
      if (pastBtn) {
        pastBtn.style.display = 'none';
        pastBtn.style.opacity = '0';
      }
      if (partBtn) {
        partBtn.style.display = 'none';
        partBtn.style.opacity = '0';
      }
    }

    function typingNext() { typing.idx = (typing.idx + 1) % typing.order.length; typingLoad(); }

    // ============================
    // Sistema de Verbos Problem√°ticos
    // ============================
    function markProblemVerb(verb, isAutoMarked = false) {
      const now = Date.now();
      if (!problemVerbs[verb.id]) {
        problemVerbs[verb.id] = {
          markedAt: now,
          autoMarked: isAutoMarked,
          attempts: 0,
          lastFailed: isAutoMarked ? now : null
        };
      } else if (isAutoMarked) {
        problemVerbs[verb.id].lastFailed = now;
        problemVerbs[verb.id].attempts++;
      }
      saveJSON(LS_KEYS.problemVerbs, problemVerbs);
      updateProblemVerbsUI();
    }

    function unmarkProblemVerb(verb) {
      delete problemVerbs[verb.id];
      saveJSON(LS_KEYS.problemVerbs, problemVerbs);
      updateProblemVerbsUI();
    }

    function isProblemVerb(verb) {
      return !!problemVerbs[verb.id];
    }

    function getProblemVerbs(filter = 'all') {
      const problems = Object.keys(problemVerbs).map(id => {
        const verb = verbs.find(v => v.id === id);
        return verb ? { verb, data: problemVerbs[id] } : null;
      }).filter(Boolean);

      if (filter === 'auto') return problems.filter(p => p.data.autoMarked);
      if (filter === 'manual') return problems.filter(p => !p.data.autoMarked);
      return problems;
    }

    function updateProblemVerbsUI() {
      const total = Object.keys(problemVerbs).length;
      const auto = getProblemVerbs('auto').length;
      const manual = getProblemVerbs('manual').length;
      
      // Actualizar badge en la pesta√±a desktop
      const badge = $('#problem-count-badge');
      if (badge) {
        badge.textContent = total;
        badge.classList.toggle('hidden', total === 0);
      }
      
      // Actualizar badge en la pesta√±a m√≥vil
      const mobileBadge = $('#mobile-problem-count-badge');
      if (mobileBadge) {
        mobileBadge.textContent = total;
        mobileBadge.classList.toggle('hidden', total === 0);
      }
      
      // Actualizar contadores en la pesta√±a de problem√°ticos
      const totalEl = $('#total-problem-verbs');
      const autoEl = $('#auto-marked-count');
      const manualEl = $('#manual-marked-count');
      const studyBtn = $('#study-problem-verbs');
      
      if (totalEl) totalEl.textContent = `(${total})`;
      if (autoEl) autoEl.textContent = auto;
      if (manualEl) manualEl.textContent = manual;
      if (studyBtn) studyBtn.disabled = total === 0;
      
      // Actualizar bot√≥n en flashcards
      updateProblemButtonState();
      
      // Renderizar lista si estamos en la pesta√±a
      const problemTab = $('#tab-problem');
      if (problemTab && !problemTab.classList.contains('hidden')) {
        renderProblemVerbsList();
      }
    }

    function updateProblemButtonState() {
      const v = ui.currentVerb();
      if (!v) return;
      
      const btn = $('#toggle-problem-verb');
      const icon = $('#problem-icon');
      const text = $('#problem-text');
      
      if (!btn || !icon || !text) return;
      
      const isMarked = isProblemVerb(v);
      const isAuto = isMarked && problemVerbs[v.id].autoMarked;
      
      if (isMarked) {
        btn.className = 'flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold border transition-all bg-rose-50 border-rose-200 text-rose-700 hover:bg-rose-100 dark:bg-rose-900/20 dark:border-rose-800 dark:text-rose-300';
        icon.textContent = isAuto ? 'üö®' : 'üìå';
        text.textContent = isAuto ? 'Marcado autom√°ticamente' : 'Desmarcar problem√°tico';
      } else {
        btn.className = 'flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold border transition-all bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300';
        icon.textContent = 'üìå';
        text.textContent = 'Marcar como problem√°tico';
      }
    }

    function renderProblemVerbsList() {
      const container = $('#problem-verbs-list');
      if (!container) return;
      
      const filter = document.querySelector('input[name="problem-filter"]:checked')?.value || 'all';
      const problems = getProblemVerbs(filter);
      
      if (problems.length === 0) {
        container.innerHTML = '<div class="p-4 text-center text-slate-500">No hay verbos problem√°ticos marcados</div>';
        return;
      }
      
      // Ordenar por fecha de marcado (m√°s recientes primero)
      problems.sort((a, b) => b.data.markedAt - a.data.markedAt);
      
      container.innerHTML = problems.map(({ verb, data }) => {
        const isAuto = data.autoMarked;
        const markedDate = new Date(data.markedAt).toLocaleDateString();
        const attempts = data.attempts || 0;
        
        return `
          <div class="flex flex-col sm:flex-row sm:items-center justify-between p-3 border-b border-slate-200 dark:border-slate-700 last:border-b-0 hover:bg-slate-50 dark:hover:bg-slate-800">
            <div class="flex-1 mb-2 sm:mb-0">
              <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2">
                <span class="text-base sm:text-lg font-semibold">${verb.infinitive}</span>
                <span class="text-xs sm:text-sm text-slate-500">${verb.translation}</span>
                <span class="text-xs px-2 py-1 rounded-full w-fit ${isAuto ? 'bg-rose-100 text-rose-700 dark:bg-rose-900/50 dark:text-rose-300' : 'bg-amber-100 text-amber-700 dark:bg-amber-900/50 dark:text-amber-300'}">
                  ${isAuto ? 'üö® Auto' : 'üìå Manual'}
                </span>
              </div>
              <div class="text-xs text-slate-400 mt-1">
                Marcado: ${markedDate}${attempts > 0 ? ` ‚Ä¢ ${attempts} ${attempts === 1 ? 'fallo' : 'fallos'}` : ''}
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button class="study-single-problem text-xs sm:text-sm px-2 sm:px-3 py-1 rounded-lg bg-brand-100 text-brand-700 hover:bg-brand-200 dark:bg-brand-900/30 dark:text-brand-300" data-verb-id="${verb.id}">
                <span class="hidden sm:inline">Estudiar</span>
                <span class="sm:hidden">üìö</span>
              </button>
              <button class="remove-problem text-xs sm:text-sm px-2 sm:px-3 py-1 rounded-lg bg-slate-100 text-slate-600 hover:bg-slate-200 dark:bg-slate-700 dark:text-slate-300" data-verb-id="${verb.id}">
                <span class="hidden sm:inline">Quitar</span>
                <span class="sm:hidden">‚ùå</span>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderTypingShortcuts() {
      const shortcutsContainer = $('#typing-shortcuts');
      if (!shortcutsContainer) return;
      
      const showKey = isMac ? 'Cmd+H' : 'Ctrl+H';
      
      shortcutsContainer.innerHTML = `
        <div><kbd class="px-1.5 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600">Enter</kbd> Comprobar</div>
        <div><kbd class="px-1.5 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600">${modifierKey}+Enter</kbd> Siguiente</div>
        <div><kbd class="px-1.5 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600">${showKey}</kbd> Mostrar</div>
      `;
    }

    function renderFlashcardShortcuts() {
      const shortcutsContainer = $('#flashcard-shortcuts');
      if (!shortcutsContainer) return;
      
      shortcutsContainer.innerHTML = `
        <div><kbd class="px-1 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-xs">‚Üê</kbd> <kbd class="px-1 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-xs">‚Üí</kbd> Navegar</div>
        <div><kbd class="px-1 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-xs">Space</kbd> Voltear tarjeta</div>
        <div><kbd class="px-1 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-xs">1</kbd><kbd class="px-1 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-xs">2</kbd><kbd class="px-1 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-xs">3</kbd> Calificar</div>
        <div><kbd class="px-1 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-xs">S</kbd> Escuchar</div>
        <div><kbd class="px-1 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-xs">R</kbd> Tarjeta aleatoria</div>
      `;
    }

    function renderMultipleChoiceShortcuts() {
      const shortcutsContainer = $('#mc-shortcuts');
      if (!shortcutsContainer) return;
      
      shortcutsContainer.innerHTML = `
        <div><kbd class="px-1 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-xs">1</kbd><kbd class="px-1 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-xs">2</kbd><kbd class="px-1 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-xs">3</kbd><kbd class="px-1 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-xs">4</kbd> Elegir pasado</div>
        <div><kbd class="px-1 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-xs">Q</kbd><kbd class="px-1 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-xs">W</kbd><kbd class="px-1 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-xs">E</kbd><kbd class="px-1 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-xs">R</kbd> Elegir participio</div>
        <div><kbd class="px-1 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-xs">Enter</kbd> Siguiente pregunta</div>
        <div><kbd class="px-1 py-0.5 rounded bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-xs">S</kbd> Escuchar infinitivo</div>
      `;
    }

    // ============================
    // Multiple Choice
    // ============================
    const mc = { order: [], idx: 0, score: 0, selectedPast: null, selectedPart: null, current() { return verbs[this.order[this.idx]]; } };

    function mcStart() {
      mc.order = verbs.map((_, i) => i);
      shuffleInPlace(mc.order); mc.idx = 0; mc.score = 0; mc.selectedPast = mc.selectedPart = null; mcLoad();
    }

    function buildOptions(correct, picker) {
      const opts = new Set([normalizeForm(parseOptions(correct)[0] || correct).toLowerCase()]);
      while (opts.size < 4) {
        const r = picker();
        const pick = normalizeForm(parseOptions(r)[0] || r).toLowerCase();
        opts.add(pick);
      }
      return shuffleInPlace([...opts]);
    }

    function renderOption(parent, text, group, isCorrect) {
      const btn = document.createElement('button');
      btn.className = 'opt rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 hover:border-brand-400';
      btn.textContent = text;
      
      // Agregar n√∫mero de opci√≥n para los atajos de teclado
      const optionIndex = parent.children.length;
      btn.dataset.optionIndex = optionIndex;
      
      const selectOption = () => {
        $$('.opt[data-group=' + group + ']', parent).forEach(b => b.classList.remove('ring-2', 'ring-emerald-500', 'ring-rose-500'));
        btn.classList.add('ring-2', isCorrect ? 'ring-emerald-500' : 'ring-rose-500');
        if (group === 'past') mc.selectedPast = isCorrect; else mc.selectedPart = isCorrect;
        if (mc.selectedPast !== null && mc.selectedPart !== null) {
          const v = mc.current();
          if (mc.selectedPast && mc.selectedPart) { mc.score++; schedule(v, 'good'); } else { schedule(v, 'hard'); }
          $('#mc-score').textContent = mc.score;
        }
      };
      
      btn.addEventListener('click', selectOption);
      btn.dataset.group = group;
      btn.selectOption = selectOption; // Para poder llamarla desde los atajos
      parent.appendChild(btn);
    }

    function mcLoad() {
      const v = mc.current(); if (!v) return;
      $('#mc-inf').textContent = v.infinitive; $('#mc-trans').textContent = v.translation || '';
      const pastOpts = buildOptions(v.pastSimple, () => verbs[randInt(0, verbs.length - 1)].pastSimple);
      const partOpts = buildOptions(v.participle, () => verbs[randInt(0, verbs.length - 1)].participle);
      const pastParent = $('#mc-opts-past'); const partParent = $('#mc-opts-part');
      pastParent.innerHTML = ''; partParent.innerHTML = '';
      for (const o of pastOpts) renderOption(pastParent, o, 'past', parseOptions(v.pastSimple).includes(o));
      for (const o of partOpts) renderOption(partParent, o, 'part', parseOptions(v.participle).includes(o));
      mc.selectedPast = mc.selectedPart = null;
    }

    function mcNext() { mc.idx = (mc.idx + 1) % mc.order.length; mcLoad(); renderTopStats(); }

    // ============================
    // Estad√≠sticas
    // ============================
    function renderStats() {
      // barras diarias
      const labels = []; const vals = [];
      for (let i = 6; i >= 0; i--) {
        const d = new Date(Date.now() - i * 86400000);
        const k = d.toISOString().slice(0, 10);
        labels.push(d.toLocaleDateString(undefined, { weekday: 'short' }));
        vals.push(history[k]?.correct || 0);
      }
      const max = Math.max(1, ...vals);
      const bars = $('#daily-bars'); const labs = $('#daily-labels'); bars.innerHTML = ''; labs.innerHTML = '';
      vals.forEach(v => {
        const h = Math.round((v / max) * 100);
        const bar = document.createElement('div');
        bar.className = 'rounded-xl bg-gradient-to-b from-brand-400 to-brand-600';
        bar.style.height = h + '%';
        bars.appendChild(bar);
      });
      labels.forEach(l => { const s = document.createElement('div'); s.textContent = l; labs.appendChild(s); });

      // dist SRS
      const dist = [1, 2, 3, 4, 5].map(box => verbs.filter(v => (srs[v.id]?.box || 1) === box).length);
      const distWrap = $('#srs-dist'); distWrap.innerHTML = '';
      dist.forEach((count, i) => {
        const el = document.createElement('div');
        el.className = 'rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-4 text-center';
        el.innerHTML = `<div class="text-sm text-slate-500">Caja ${i + 1}</div><div class="mt-2 text-2xl font-extrabold">${count}</div>`;
        distWrap.appendChild(el);
      });
    }

    // ============================
    // Config / CRUD
    // ============================
    function exportJson() {
      const data = { verbs, srs, settings, history, streak };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'verbos_irregulares_backup.json'; a.click(); URL.revokeObjectURL(url);
    }

    async function importJson(file) {
      const text = await file.text();
      try {
        const data = JSON.parse(text);
        if (!Array.isArray(data.verbs)) throw new Error('Formato inv√°lido: verbs no es array');
        verbs = data.verbs; ensureIds();
        srs = data.srs || {}; settings = { ...settings, ...(data.settings || {}) };
        history = data.history || {}; streak = data.streak || { lastDay: null, count: 0 };
        saveJSON(LS_KEYS.verbs, verbs); saveJSON(LS_KEYS.srs, srs); saveJSON(LS_KEYS.settings, settings); saveJSON(LS_KEYS.history, history); saveJSON(LS_KEYS.streak, streak);
        afterDataChange();
        alert('Importaci√≥n completa.');
      } catch (e) { alert('Error al importar: ' + e.message); }
    }

    function addVerb() {
      const inf = normalizeForm($('#add-inf').value);
      const trans = $('#add-trans').value.trim();
      const past = $('#add-past').value.trim();
      const part = $('#add-part').value.trim();
      if (!inf || !past || !part) { alert('Infinitivo, pasado y participio son obligatorios'); return; }
      const newVerb = { id: `${inf}-${Date.now()}`, infinitive: inf, pastSimple: past, participle: part, translation: trans };
      verbs.push(newVerb); saveJSON(LS_KEYS.verbs, verbs); afterDataChange();
      $('#add-inf').value = $('#add-trans').value = $('#add-past').value = $('#add-part').value = '';
      alert('Verbo a√±adido');
    }

    function afterDataChange() {
      ui.order = verbs.map((_, i) => i); ui.idx = 0;
      renderTopStats(); renderQuickList($('#search-input').value); renderFlashcard(); renderStats();
      $('#total-verbs').textContent = verbs.length;
    }

    // ============================
    // Tabs & Theme
    // ============================
    function setActiveTab(id) {
      $$('.tab-panel').forEach(p => p.classList.add('hidden'));
      $(`#tab-${id}`).classList.remove('hidden');
      
      // Desktop tabs
      $$('.tab-btn').forEach(b => b.classList.remove('bg-white', 'dark:bg-slate-900', 'shadow'));
      $(`.tab-btn[data-tab="${id}"]`).classList.add('bg-white', 'dark:bg-slate-900', 'shadow');
      
      // Mobile tab selector
      updateMobileTabSelector(id);
      
      // Close mobile dropdown
      $('#mobile-tab-dropdown').classList.add('hidden');
      $('#mobile-tab-arrow').classList.remove('rotate-180');
      
      if (id === 'stats') renderStats();
      if (id === 'problem') renderProblemVerbsList();
    }

    function updateMobileTabSelector(tabId) {
      const tabConfig = {
        flashcards: { icon: 'üìö', text: 'Flashcards' },
        typing: { icon: '‚úèÔ∏è', text: 'Escribir' },
        choice: { icon: 'üéØ', text: 'Opci√≥n m√∫ltiple' },
        problem: { icon: 'üìö', text: 'Problem√°ticos' },
        stats: { icon: 'üìä', text: 'Estad√≠sticas' },
        config: { icon: '‚öôÔ∏è', text: 'Config' }
      };
      
      const config = tabConfig[tabId];
      if (config) {
        $('#mobile-tab-icon').textContent = config.icon;
        $('#mobile-tab-text').textContent = config.text;
      }
    }

    function applyTheme(dark) {
      const root = document.documentElement;
      root.classList.toggle('dark', dark);
      settings.darkDefault = !!dark; saveJSON(LS_KEYS.settings, settings);
    }

    function initTheme() {
      const dark = settings.darkDefault || window.matchMedia('(prefers-color-scheme: dark)').matches;
      applyTheme(dark);
    }

    // ============================
    // Event Listeners (UI)
    // ============================
    function bindEvents() {
      // Tabs
      $$('.tab-btn').forEach(btn => btn.addEventListener('click', () => setActiveTab(btn.dataset.tab)));
      
      // Mobile tab selector
      $('#mobile-tab-selector').addEventListener('click', () => {
        const dropdown = $('#mobile-tab-dropdown');
        const arrow = $('#mobile-tab-arrow');
        dropdown.classList.toggle('hidden');
        arrow.classList.toggle('rotate-180');
      });
      
      // Mobile tab options
      $$('.mobile-tab-option').forEach(btn => btn.addEventListener('click', () => setActiveTab(btn.dataset.tab)));
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        const selector = $('#mobile-tab-selector');
        const dropdown = $('#mobile-tab-dropdown');
        const arrow = $('#mobile-tab-arrow');
        
        if (!selector.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.add('hidden');
          arrow.classList.remove('rotate-180');
        }
      });
      // Theme toggle
      $('#theme-toggle').addEventListener('click', () => applyTheme(!document.documentElement.classList.contains('dark')));
      // Search
      $('#search-input').addEventListener('input', (e) => renderQuickList(e.target.value));
      $('#mobile-search-input').addEventListener('input', (e) => renderQuickList(e.target.value));
      
      // Mobile search toggle
      $('#mobile-search-toggle').addEventListener('click', () => {
        const mobileSearch = $('#mobile-search');
        const mobileMenu = $('#mobile-menu');
        
        // Cerrar men√∫ si est√° abierto
        mobileMenu.classList.add('hidden');
        
        mobileSearch.classList.toggle('hidden');
        if (!mobileSearch.classList.contains('hidden')) {
          $('#mobile-search-input').focus();
        }
      });
      
      // Mobile menu toggle
      $('#mobile-menu-toggle').addEventListener('click', () => {
        const mobileMenu = $('#mobile-menu');
        const mobileSearch = $('#mobile-search');
        
        // Cerrar b√∫squeda si est√° abierta
        mobileSearch.classList.add('hidden');
        
        mobileMenu.classList.toggle('hidden');
      });
      
      // Mobile theme toggle
      $('#theme-toggle-mobile').addEventListener('click', () => applyTheme(!document.documentElement.classList.contains('dark')));
      
      // Mobile reset progress
      $('#reset-progress-mobile').addEventListener('click', () => {
        if (confirm('Esto borrar√° tu progreso (SRS, historial y racha). ¬øContinuar?')) {
          srs = {}; history = {}; streak = { lastDay: null, count: 0 };
          saveJSON(LS_KEYS.srs, srs); saveJSON(LS_KEYS.history, history); saveJSON(LS_KEYS.streak, streak);
          renderTopStats(); renderStats();
          $('#mobile-menu').classList.add('hidden');
        }
      });
      // Quick nav
      $('#prev-btn').addEventListener('click', () => nav(-1));
      $('#next-btn').addEventListener('click', () => nav(+1));
      $('#random-btn').addEventListener('click', randomCard);
      // Flip
      $('#flashcard').addEventListener('click', flipCard);
      // Grade buttons
      $$('.grade-btn').forEach(b => b.addEventListener('click', () => gradeCurrent(b.dataset.grade)));
      // TTS
      $('#fc-speak-inf').addEventListener('click', (e) => { e.stopPropagation(); const v = ui.currentVerb(); speak(normalizeForm(v.infinitive, { forPronunciation: true })); });
      $('#fc-speak-inf-back').addEventListener('click', (e) => { e.stopPropagation(); const v = ui.currentVerb(); speak(normalizeForm(v.infinitive, { forPronunciation: true })); });
      $('#fc-speak-past').addEventListener('click', (e) => { e.stopPropagation(); const v = ui.currentVerb(); speak(normalizeForm(parseOptions(v.pastSimple)[0] || v.pastSimple, { forPronunciation: true })); });
      $('#fc-speak-part').addEventListener('click', (e) => { e.stopPropagation(); const v = ui.currentVerb(); speak(normalizeForm(parseOptions(v.participle)[0] || v.participle, { forPronunciation: true })); });
      $('#mc-speak').addEventListener('click', () => { const v = mc.current(); speak(v.infinitive); });

      // Toggles
      $('#toggle-due-only').addEventListener('change', (e) => { ui.dueOnly = e.target.checked; reshuffleOrder(); renderFlashcard(); renderTopStats(); });
      $('#toggle-auto-tts').addEventListener('change', (e) => { ui.autoTts = e.target.checked; settings.autoTts = ui.autoTts; saveJSON(LS_KEYS.settings, settings); });
      $('#range-tts').addEventListener('input', (e) => { ui.ttsRate = Number(e.target.value); settings.ttsRate = ui.ttsRate; saveJSON(LS_KEYS.settings, settings); });

      // Typing
      $('#t-check').addEventListener('click', typingCheck);
      $('#t-show').addEventListener('click', typingShow);
      $('#typing-next').addEventListener('click', typingNext);
      $('#typing-reset').addEventListener('click', typingStart);
      
      // Audio buttons for typing section
      $('#t-speak-inf').addEventListener('click', () => {
        const v = typing.current();
        if (v) speak(normalizeForm(v.infinitive, { forPronunciation: true }));
      });
      $('#t-speak-past').addEventListener('click', () => {
        const v = typing.current();
        if (v) speak(normalizeForm(parseOptions(v.pastSimple)[0] || v.pastSimple, { forPronunciation: true }));
      });
      $('#t-speak-part').addEventListener('click', () => {
        const v = typing.current();
        if (v) speak(normalizeForm(parseOptions(v.participle)[0] || v.participle, { forPronunciation: true }));
      });
      $('#t-input-part').addEventListener('keypress', (e) => { if (e.key === 'Enter' && !$('#t-check').disabled) typingCheck(); });
      
      // Atajos de teclado espec√≠ficos para la secci√≥n de escritura
      function handleTypingKeydown(e) {
        const modifierPressed = isMac ? e.metaKey : e.ctrlKey;
        
        if (e.key === 'Enter' && !modifierPressed && !$('#t-check').disabled) {
          e.preventDefault();
          typingCheck();
        } else if (e.key === 'Enter' && modifierPressed) {
          // Cmd+Enter siempre funciona para ir al siguiente, sin importar el estado
          e.preventDefault();
          typingNext();
        } else if (e.key.toLowerCase() === 'h' && modifierPressed && !$('#t-show').disabled) {
          e.preventDefault();
          typingShow();
        }
      }
      
      // Tambi√©n agregar un listener global para la pesta√±a de escritura
      window.addEventListener('keydown', (e) => {
        // Solo funcionar cuando la pesta√±a de escritura est√© activa
        const typingTab = $('#tab-typing');
        if (!typingTab || typingTab.classList.contains('hidden')) return;
        
        const modifierPressed = isMac ? e.metaKey : e.ctrlKey;
        
        if (e.key === 'Enter' && modifierPressed) {
          e.preventDefault();
          typingNext();
        } else if (e.key.toLowerCase() === 'h' && modifierPressed && !$('#t-show').disabled) {
          e.preventDefault();
          typingShow();
        }
      });

      // Listener global para la pesta√±a de opci√≥n m√∫ltiple
      window.addEventListener('keydown', (e) => {
        // Solo funcionar cuando la pesta√±a de opci√≥n m√∫ltiple est√© activa
        const mcTab = $('#tab-choice');
        if (!mcTab || mcTab.classList.contains('hidden')) return;
        if (document.activeElement && ['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
        
        // Teclas 1-4 para seleccionar opciones de pasado simple
        if (['1', '2', '3', '4'].includes(e.key)) {
          e.preventDefault();
          const optionIndex = parseInt(e.key) - 1;
          const pastOptions = $$('#mc-opts-past .opt');
          if (pastOptions[optionIndex]) {
            pastOptions[optionIndex].selectOption();
          }
        }
        
        // Teclas Q, W, E, R para seleccionar opciones de participio
        const participleKeys = { 'q': 0, 'w': 1, 'e': 2, 'r': 3 };
        if (participleKeys.hasOwnProperty(e.key.toLowerCase())) {
          e.preventDefault();
          const optionIndex = participleKeys[e.key.toLowerCase()];
          const partOptions = $$('#mc-opts-part .opt');
          if (partOptions[optionIndex]) {
            partOptions[optionIndex].selectOption();
          }
        }
        
        // Enter para siguiente pregunta
        if (e.key === 'Enter') {
          e.preventDefault();
          mcNext();
        }
        
        // S para escuchar
        if (e.key.toLowerCase() === 's') {
          e.preventDefault();
          const v = mc.current();
          if (v) speak(v.infinitive);
        }
      });
      
      $('#t-input-past').addEventListener('keydown', handleTypingKeydown);
      $('#t-input-part').addEventListener('keydown', handleTypingKeydown);

      // Multiple Choice
      $('#mc-next').addEventListener('click', mcNext);

      // Config
      $('#export-json').addEventListener('click', exportJson);
      $('#import-json').addEventListener('change', (e) => { if (e.target.files[0]) importJson(e.target.files[0]); });
      $('#add-verb').addEventListener('click', addVerb);
      $('#pref-dark-default').checked = !!settings.darkDefault;
      $('#pref-dark-default').addEventListener('change', (e) => applyTheme(e.target.checked));
      $('#pref-due-default').checked = !!settings.dueOnlyDefault;
      $('#pref-due-default').addEventListener('change', (e) => { settings.dueOnlyDefault = e.target.checked; saveJSON(LS_KEYS.settings, settings); });

      // Reset progreso
      $('#reset-progress').addEventListener('click', () => {
        if (confirm('Esto borrar√° tu progreso (SRS, historial y racha). ¬øContinuar?')) {
          srs = {}; history = {}; streak = { lastDay: null, count: 0 };
          saveJSON(LS_KEYS.srs, srs); saveJSON(LS_KEYS.history, history); saveJSON(LS_KEYS.streak, streak);
          renderTopStats(); renderStats();
        }
      });

      // Problem verbs functionality
      $('#toggle-problem-verb').addEventListener('click', () => {
        const v = ui.currentVerb();
        if (!v) return;
        
        if (isProblemVerb(v)) {
          // Solo desmarcar si no es auto-marcado o si es manual
          if (!problemVerbs[v.id].autoMarked) {
            unmarkProblemVerb(v);
          }
        } else {
          markProblemVerb(v, false); // Marcado manual
        }
      });

      $('#study-problem-verbs').addEventListener('click', () => {
        const problems = getProblemVerbs();
        if (problems.length === 0) return;
        
        // Cambiar a flashcards y configurar orden solo con problem√°ticos
        ui.order = problems.map(p => verbs.findIndex(v => v.id === p.verb.id)).filter(i => i !== -1);
        ui.idx = 0;
        renderFlashcard();
        setActiveTab('flashcards');
      });

      $('#clear-all-problems').addEventListener('click', () => {
        if (confirm('¬øEst√°s seguro de que quieres limpiar todos los verbos problem√°ticos?')) {
          problemVerbs = {};
          saveJSON(LS_KEYS.problemVerbs, problemVerbs);
          updateProblemVerbsUI();
        }
      });

      // Event delegation for problem verbs list
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('study-single-problem')) {
          const verbId = e.target.dataset.verbId;
          const verbIndex = verbs.findIndex(v => v.id === verbId);
          if (verbIndex !== -1) {
            ui.order = [verbIndex];
            ui.idx = 0;
            renderFlashcard();
            setActiveTab('flashcards');
          }
        } else if (e.target.classList.contains('remove-problem')) {
          const verbId = e.target.dataset.verbId;
          const verb = verbs.find(v => v.id === verbId);
          if (verb) {
            unmarkProblemVerb(verb);
          }
        }
      });

      // Problem filter radio buttons
      document.addEventListener('change', (e) => {
        if (e.target.name === 'problem-filter') {
          renderProblemVerbsList();
        }
      });

      // Keybindings
      window.addEventListener('keydown', (e) => {
        if (document.activeElement && ['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
        // Solo aplicar atajos de flashcards cuando esa pesta√±a est√© activa
        const flashcardTab = $('#tab-flashcards');
        if (!flashcardTab || flashcardTab.classList.contains('hidden')) return;
        
        if (e.key === ' ') { e.preventDefault(); flipCard(); }
        if (e.key === 'ArrowLeft') nav(-1);
        if (e.key === 'ArrowRight') nav(+1);
        if (e.key === '1') gradeCurrent('hard');
        if (e.key === '2') gradeCurrent('good');
        if (e.key === '3') gradeCurrent('easy');
        if (e.key.toLowerCase() === 's') { const v = ui.currentVerb(); if (v) speak(v.infinitive); }
        if (e.key.toLowerCase() === 'r') { e.preventDefault(); randomCard(); }
      });
    }

    // ============================
    // Init
    // ============================
    function init() {
      initTheme();
      // Defaults UI
      $('#toggle-due-only').checked = !!ui.dueOnly;
      $('#toggle-auto-tts').checked = !!ui.autoTts;
      $('#range-tts').value = ui.ttsRate;
      // Prepare orders
      reshuffleOrder();
      renderTopStats();
      renderQuickList('');
      renderFlashcard();
      // start games
      typingStart();
      mcStart();
      // Render shortcuts for sections
      renderTypingShortcuts();
      renderFlashcardShortcuts();
      renderMultipleChoiceShortcuts();
      // Initialize problem verbs UI
      updateProblemVerbsUI();
      // Bind events
      bindEvents();
      // Default tab
      setActiveTab('flashcards');
      // Voices changed (Chrome async)
      if ('speechSynthesis' in window && typeof window.speechSynthesis.onvoiceschanged !== 'undefined') {
        window.speechSynthesis.onvoiceschanged = () => { /* loaded */ };
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>

</html>
